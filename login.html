<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Página de login da Andev Web">
  <title>Andev Web - Entrar</title>
  <link rel='stylesheet' href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css'>
  <link rel="stylesheet" href="cs/login.css">
</head>
<body>
  <main class="main-content">
    <div class="wrapper">
      <div class="login_box">
        <header class="login-header">
          <h1>Entrar</h1>
        </header>
        <form id="loginForm" class="login-form" novalidate>
          <div class="input_box">
            <input type="text" id="user" class="input-field" placeholder=" " required>
            <label for="user" class="label">Nome de usuário</label>
            <i class="bx bx-user icon" aria-hidden="true"></i>
            <span class="error-message" id="user-error"></span>
          </div>
          <div class="input_box">
            <input type="password" id="pass" class="input-field" placeholder=" " required>
            <label for="pass" class="label">Senha</label>
            <i class="bx bx-lock-alt icon" aria-hidden="true"></i>
            <i class="bx bx-show-alt show-icon" id="togglePassword" role="button" aria-label="Mostrar senha" tabindex="0"></i>
            <span class="error-message" id="pass-error"></span>
          </div>
          <div class="remember-forgot">
            <div class="remember-me">
              <input type="checkbox" id="remember">
              <label for="remember">Lembrar-me</label>
            </div>
            <div class="forgot">
              <a href="#" aria-label="Recuperar senha esquecida">Esqueceu a senha?</a>
            </div>
          </div>
          <div class="input_box">
            <input type="submit" class="input-submit" value="Entrar">
          </div>
          <div class="social-login-title">
            <span>Entrar com redes sociais</span>
          </div>
          <div class="social-login">
            <button type="button" class="social-button google-button" id="googleLogin" aria-label="Entrar com Google">
              <i class='bx bxl-google google-icon' aria-hidden="true"></i>
            </button>
            <button type="button" class="social-button microsoft-button" id="microsoftLogin" aria-label="Entrar com Microsoft">
              <i class='bx bxl-microsoft microsoft-icon' aria-hidden="true"></i>
            </button>
          </div>
          <div class="register">
            <p>Não tem uma conta? <a href="#" aria-label="Ir para página de cadastro">Cadastrar-se</a></p>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Modal de seleção de método de login -->
  <div class="social-modal" id="socialModal">
    <div class="social-modal-content">
      <div class="social-modal-header">
        <div class="social-modal-title" id="modalTitle">
          <i class='bx bxl-google social-provider-icon'></i>
          <span>Entrar com Google</span>
        </div>
        <button class="social-modal-close" id="modalClose" aria-label="Fechar">
          <i class='bx bx-x'></i>
        </button>
      </div>
      
      <div class="social-options">
        <div class="social-option" id="optionEmail">
          <i class='bx bx-envelope'></i>
          <div class="option-info">
            <h3>Usar meu e-mail</h3>
            <p>Enviaremos um link mágico para seu e-mail</p>
          </div>
        </div>
        
        <div class="social-option" id="optionOAuth">
          <i class='bx bx-log-in-circle'></i>
          <div class="option-info">
            <h3>Continuar com OAuth</h3>
            <p>Autenticação direta com Google</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para email -->
  <div class="social-modal" id="emailModal">
    <div class="social-modal-content">
      <div class="social-modal-header">
        <div class="social-modal-title" id="emailModalTitle">
          <i class='bx bx-envelope social-provider-icon'></i>
          <span>Entrar com e-mail</span>
        </div>
        <button class="social-modal-close" id="emailModalClose" aria-label="Fechar">
          <i class='bx bx-x'></i>
        </button>
      </div>
      
      <form class="social-email-form" id="socialEmailForm">
        <div class="input_box">
          <input type="email" id="socialEmail" class="input-field" placeholder=" " required>
          <label for="socialEmail" class="label">Endereço de e-mail</label>
          <i class="bx bx-envelope icon" aria-hidden="true"></i>
          <span class="error-message" id="social-email-error"></span>
        </div>
        
        <button type="submit" class="social-submit-btn" id="socialSubmit">
          <i class='bx bx-send'></i>
          Enviar link de acesso
        </button>
        
        <div class="social-terms">
          <p>Ao continuar, você concorda com nossos <a href="#">Termos de Serviço</a> e <a href="#">Política de Privacidade</a>.</p>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Configurações OAuth - EM PRODUÇÃO, USE VARIÁVEIS DE AMBIENTE
    const OAUTH_CONFIG = {
      google: {
        clientId: 'SEU_GOOGLE_CLIENT_ID.apps.googleusercontent.com',
        scope: 'email profile openid',
        authUrl: 'https://accounts.google.com/o/oauth2/v2/auth',
        redirectUri: `${window.location.origin}/auth/callback`
      },
      microsoft: {
        clientId: 'SEU_MICROSOFT_CLIENT_ID',
        scope: 'user.read openid profile email',
        authUrl: 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize',
        redirectUri: `${window.location.origin}/auth/callback`
      }
    };

    // Códigos de requisição únicos (como no Java)
    const REQUEST_CODE_GOOGLE_SIGN_IN = 1001;
    const REQUEST_CODE_MICROSOFT_SIGN_IN = 1002;

    document.addEventListener('DOMContentLoaded', function() {
      const togglePassword = document.querySelector('#togglePassword');
      const password = document.querySelector('#pass');
      const loginForm = document.querySelector('#loginForm');
      const usernameInput = document.querySelector('#user');
      const googleLoginBtn = document.querySelector('#googleLogin');
      const microsoftLoginBtn = document.querySelector('#microsoftLogin');
      
      // Elementos dos modais
      const socialModal = document.querySelector('#socialModal');
      const modalClose = document.querySelector('#modalClose');
      const emailModal = document.querySelector('#emailModal');
      const emailModalClose = document.querySelector('#emailModalClose');
      const socialEmailForm = document.querySelector('#socialEmailForm');
      const socialEmailInput = document.querySelector('#socialEmail');
      
      // Opções de login
      const optionEmail = document.querySelector('#optionEmail');
      const optionOAuth = document.querySelector('#optionOAuth');
      
      let currentProvider = '';
      
      // Alternar visibilidade da senha
      togglePassword.addEventListener('click', function() {
        const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
        password.setAttribute('type', type);
        this.classList.toggle('bx-show-alt');
        this.classList.toggle('bx-hide');
        
        const isVisible = type === 'text';
        this.setAttribute('aria-label', isVisible ? 'Ocultar senha' : 'Mostrar senha');
      });
      
      togglePassword.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.click();
        }
      });
      
      // Validação em tempo real
      usernameInput.addEventListener('input', function() {
        validateField(this, /^[a-zA-Z0-9_]{3,20}$/, 'Nome de usuário deve ter entre 3 e 20 caracteres');
      });
      
      password.addEventListener('input', function() {
        validateField(this, /^.{6,}$/, 'A senha deve ter pelo menos 6 caracteres');
      });
      
      // Login com Google - Abre modal de opções
      googleLoginBtn.addEventListener('click', function() {
        currentProvider = 'google';
        openSocialModal('Google', 'bxl-google', 'google-provider');
      });
      
      // Login com Microsoft - Abre modal de opções
      microsoftLoginBtn.addEventListener('click', function() {
        currentProvider = 'microsoft';
        openSocialModal('Microsoft', 'bxl-microsoft', 'microsoft-provider');
      });
      
      // Opção de email
      optionEmail.addEventListener('click', function() {
        closeSocialModal();
        openEmailModal();
      });
      
      // Opção OAuth (autenticação direta)
      optionOAuth.addEventListener('click', function() {
        closeSocialModal();
        signInWithOAuth(currentProvider);
      });
      
      // Fechar modais
      modalClose.addEventListener('click', closeSocialModal);
      emailModalClose.addEventListener('click', closeEmailModal);
      
      // Fechar modais ao clicar fora
      socialModal.addEventListener('click', function(e) {
        if (e.target === socialModal) closeSocialModal();
      });
      
      emailModal.addEventListener('click', function(e) {
        if (e.target === emailModal) closeEmailModal();
      });
      
      // Fechar modais com ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          if (socialModal.classList.contains('active')) closeSocialModal();
          if (emailModal.classList.contains('active')) closeEmailModal();
        }
      });
      
      // Enviar formulário de email
      socialEmailForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateEmail(socialEmailInput.value)) {
          sendMagicLink(socialEmailInput.value, currentProvider);
        } else {
          showMessage('Por favor, insira um endereço de email válido.', 'error');
        }
      });
      
      // Validação do formulário principal
      loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const isUsernameValid = validateField(usernameInput, /^[a-zA-Z0-9_]{3,20}$/, 'Nome de usuário deve ter entre 3 e 20 caracteres');
        const isPasswordValid = validateField(password, /^.{6,}$/, 'A senha deve ter pelo menos 6 caracteres');
        
        if (isUsernameValid && isPasswordValid) {
          const username = usernameInput.value;
          const passwordValue = password.value;
          
          // Autenticação tradicional
          if (username === 'admin' && passwordValue === 'password123') {
            showMessage('Login bem-sucedido! Redirecionando...', 'success');
            setTimeout(() => {
              console.log('Redirecionando para o dashboard...');
              // window.location.href = 'dashboard.html';
            }, 1500);
          } else {
            showMessage('Nome de usuário ou senha incorretos.', 'error');
          }
        }
      });
      
      // Verificar se há parâmetros de callback OAuth na URL
      checkOAuthCallback();
      
      // ========== FUNÇÕES PRINCIPAIS ==========
      
      function openSocialModal(providerName, iconClass, providerClass) {
        const modalTitle = document.querySelector('#modalTitle');
        modalTitle.innerHTML = `
          <i class='bx ${iconClass} social-provider-icon'></i>
          <span>Entrar com ${providerName}</span>
        `;
        modalTitle.className = `social-modal-title ${providerClass}`;
        socialModal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
      
      function closeSocialModal() {
        socialModal.classList.remove('active');
        document.body.style.overflow = '';
      }
      
      function openEmailModal() {
        emailModal.classList.add('active');
        socialEmailInput.value = '';
        socialEmailInput.focus();
        document.body.style.overflow = 'hidden';
      }
      
      function closeEmailModal() {
        emailModal.classList.remove('active');
        document.body.style.overflow = '';
      }
      
      // Função principal de autenticação OAuth - similar ao Java
      function signInWithOAuth(provider) {
        const config = OAUTH_CONFIG[provider];
        
        if (!config) {
          showMessage('Provedor não configurado.', 'error');
          return;
        }
        
        showMessage(`Iniciando autenticação com ${provider}...`, 'info');
        
        // Parâmetros OAuth2
        const params = new URLSearchParams({
          client_id: config.clientId,
          redirect_uri: config.redirectUri,
          response_type: 'code',
          scope: config.scope,
          state: generateStateParameter(provider),
          prompt: 'select_account'
        });
        
        // URL de autorização
        const authUrl = `${config.authUrl}?${params.toString()}`;
        
        // Abrir popup OAuth (similar ao startIntentSenderForResult do Android)
        openOAuthPopup(authUrl, provider);
      }
      
      function openOAuthPopup(url, provider) {
        const width = 500;
        const height = 600;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        
        const popup = window.open(
          url,
          `${provider}OAuth`,
          `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=yes`
        );
        
        // Verificar se o popup foi bloqueado
        if (!popup) {
          showMessage('Popup bloqueado. Por favor, permita popups para este site.', 'error');
          return;
        }
        
        // Monitorar o popup
        const popupTimer = setInterval(() => {
          if (popup.closed) {
            clearInterval(popupTimer);
            showMessage('Autenticação cancelada.', 'info');
          }
          
          try {
            // Verificar se foi redirecionado para a URL de callback
            if (popup.location.href.startsWith(OAUTH_CONFIG[provider].redirectUri)) {
              clearInterval(popupTimer);
              popup.close();
              handleOAuthCallback(popup.location.href, provider);
            }
          } catch (e) {
            // Cross-origin block - isso é normal
          }
        }, 500);
      }
      
      function handleOAuthCallback(callbackUrl, provider) {
        const url = new URL(callbackUrl);
        const code = url.searchParams.get('code');
        const error = url.searchParams.get('error');
        const state = url.searchParams.get('state');
        
        if (error) {
          showMessage(`Erro na autenticação: ${error}`, 'error');
          return;
        }
        
        if (!code) {
          showMessage('Código de autorização não recebido.', 'error');
          return;
        }
        
        // Validar state parameter
        if (!validateStateParameter(state, provider)) {
          showMessage('Erro de segurança: state parameter inválido.', 'error');
          return;
        }
        
        // Trocar code por access token (em produção, faça isso no backend)
        exchangeCodeForToken(code, provider);
      }
      
      function exchangeCodeForToken(code, provider) {
        showMessage('Finalizando autenticação...', 'info');
        
        // EM PRODUÇÃO: Enviar code para seu backend
        // fetch('/api/auth/token', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify({ code, provider })
        // })
        
        // Simulação
        setTimeout(() => {
          showMessage(`Autenticação com ${provider} realizada com sucesso!`, 'success');
          console.log(`OAuth ${provider} completed - Code: ${code}`);
          
          // Redirecionar ou atualizar UI
          setTimeout(() => {
            // window.location.href = 'dashboard.html';
          }, 1000);
        }, 2000);
      }
      
      function sendMagicLink(email, provider) {
        showMessage(`Enviando link mágico para ${email}...`, 'info');
        
        // EM PRODUÇÃO: Integrar com serviço de magic links
        // fetch('/api/auth/magic-link', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify({ email, provider })
        // })
        
        // Simulação
        setTimeout(() => {
          closeEmailModal();
          showMessage(`Link de acesso enviado para ${email}`, 'success');
          console.log(`Magic link sent to ${email} for ${provider}`);
        }, 1500);
      }
      
      function checkOAuthCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const provider = urlParams.get('provider');
        
        if (code && state && provider) {
          handleOAuthCallback(window.location.href, provider);
        }
      }
      
      // ========== FUNÇÕES AUXILIARES ==========
      
      function generateStateParameter(provider) {
        const state = {
          provider: provider,
          timestamp: Date.now(),
          random: Math.random().toString(36).substring(2)
        };
        
        const stateString = btoa(JSON.stringify(state));
        sessionStorage.setItem('oauth_state', stateString);
        return stateString;
      }
      
      function validateStateParameter(state, provider) {
        try {
          const storedState = sessionStorage.getItem('oauth_state');
          if (!storedState) return false;
          
          const stateData = JSON.parse(atob(state));
          const storedData = JSON.parse(atob(storedState));
          
          sessionStorage.removeItem('oauth_state');
          
          return stateData.provider === provider && 
                 stateData.timestamp > Date.now() - 300000; // 5 minutos
        } catch (e) {
          return false;
        }
      }
      
      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }
      
      function validateField(field, regex, errorMessage) {
        const value = field.value.trim();
        const isValid = regex.test(value);
        const errorElement = document.getElementById(`${field.id}-error`);
        
        if (!isValid && value !== '') {
          if (errorElement) errorElement.textContent = errorMessage;
          field.classList.add('error');
        } else {
          if (errorElement) errorElement.textContent = '';
          field.classList.remove('error');
        }
        
        return isValid;
      }
      
      function showMessage(message, type) {
        const existingMessage = document.querySelector('.message');
        if (existingMessage) existingMessage.remove();
        
        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}`;
        messageElement.textContent = message;
        messageElement.setAttribute('role', 'alert');
        
        messageElement.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 8px;
          color: white;
          font-weight: bold;
          z-index: 1001;
          max-width: 300px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          animation: slideIn 0.3s ease;
        `;
        
        const colors = {
          success: '#4CAF50',
          error: '#f44336',
          info: '#2196F3'
        };
        
        messageElement.style.backgroundColor = colors[type] || '#2196F3';
        document.body.appendChild(messageElement);
        
        setTimeout(() => {
          messageElement.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => {
            if (messageElement.parentNode) {
              messageElement.parentNode.removeChild(messageElement);
            }
          }, 300);
        }, 5000);
      }
      
      // Adicionar estilos CSS para animações
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    });
  </script>
</body>
</html>